#!/bin/bash

set -e

red=$'\e[1;31m'
green=$'\e[1;32m'
yellow=$'\e[1;33m'
end=$'\e[0m'

echo "${yellow}IMAGEUPGRADEFILE-TPL: Pre-installation starts ...${end}"

printf "Configuring image metadata ... "
# determine build number generated by pipeline
[[ -e /setup/build ]] && BUILD=$(cat /setup/build)
[[ -z ${BUILD} ]] && BUILD='unknown'
# add image info to metadata
captool metadata --addimage -i imageupgradefile -v ${IMAGEUPGRADEFILE_VERSION} -b ${BUILD}
printf "${green}OK\n${end}"

echo "${yellow}IMAGEUPGRADEFILE-TPL: Image installation completed.${end}"


echo "${yellow}IMAGEUPGRADEFILE-TPL: Npm installation starts ...${end}"

printf "Installing npm dependencies ...${end}"
# install npm packages
curl http://repo.lxpt.cn/artifactory/ext-release/nodejs/node_modules_0.1.0.tar.gz | tar xz -C /data/app

printf "${green}Npm is OK\n${end}"

echo "${yellow}IMAGEUPGRADEFILE: Npm installation completed.${end}"